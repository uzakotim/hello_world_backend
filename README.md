# Tomatoes API

A Node.js CRUD API for managing tomatoes using Convex database and Express.js.

## Features

- **Create** tomatoes with name, variety, price, description, and stock status
- **Read** all tomatoes or get specific ones by ID
- **Update** existing tomatoes
- **Delete** tomatoes
- **Search** tomatoes by name or variety
- **Validation** for required fields and data types
- **Error handling** with proper HTTP status codes
- **Logging** for request tracking

## Prerequisites

- Node.js (v16 or higher)
- npm or yarn
- Convex account (sign up at [convex.dev](https://www.convex.dev/))

## Setup Instructions

1. **Clone or navigate to the project directory:**
   ```bash
   cd tomatoes-api
   ```

2. **Install dependencies:**
   ```bash
   npm install
   ```

3. **Set up Convex:**
   ```bash
   npx convex dev --configure
   ```
   - Follow the prompts to create a new Convex project
   - This will create a `.env.local` file with your Convex configuration

4. **Create your environment file:**
   ```bash
   cp .env.example .env
   ```
   - Update the `CONVEX_URL` in `.env` with your Convex deployment URL

5. **Deploy Convex functions:**
   ```bash
   npm run convex:dev
   ```
   - Keep this running in a separate terminal

6. **Start the server:**
   ```bash
   npm run dev
   ```
   - For production: `npm start`

## API Endpoints

### Base URL
```
http://localhost:3000
```

### Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/` | API information |
| GET | `/health` | Health check |
| GET | `/tomatoes` | Get all tomatoes |
| GET | `/tomatoes/:id` | Get a specific tomato |
| GET | `/tomatoes/search/name/:name` | Search tomatoes by name |
| GET | `/tomatoes/search/variety/:variety` | Search tomatoes by variety |
| POST | `/tomatoes` | Create a new tomato |
| PUT | `/tomatoes/:id` | Update a tomato |
| DELETE | `/tomatoes/:id` | Delete a tomato |

## Request/Response Examples

### Create a Tomato
```bash
curl -X POST http://localhost:3000/tomatoes \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Cherry Tomato",
    "variety": "Sweet 100",
    "price": 4.99,
    "description": "Small, sweet tomatoes perfect for snacking",
    "inStock": true
  }'
```

**Response:**
```json
{
  "success": true,
  "data": {
    "_id": "k123456789",
    "name": "Cherry Tomato",
    "variety": "Sweet 100",
    "price": 4.99,
    "description": "Small, sweet tomatoes perfect for snacking",
    "inStock": true,
    "createdAt": 1640995200000,
    "updatedAt": 1640995200000
  },
  "message": "Tomato created successfully"
}
```

### Get All Tomatoes
```bash
curl http://localhost:3000/tomatoes
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "_id": "k123456789",
      "name": "Cherry Tomato",
      "variety": "Sweet 100",
      "price": 4.99,
      "description": "Small, sweet tomatoes perfect for snacking",
      "inStock": true,
      "createdAt": 1640995200000,
      "updatedAt": 1640995200000
    }
  ],
  "count": 1
}
```

### Update a Tomato
```bash
curl -X PUT http://localhost:3000/tomatoes/k123456789 \
  -H "Content-Type: application/json" \
  -d '{
    "price": 5.99,
    "inStock": false
  }'
```

### Delete a Tomato
```bash
curl -X DELETE http://localhost:3000/tomatoes/k123456789
```

## Data Schema

### Tomato Object
```typescript
{
  _id: string;           // Auto-generated by Convex
  name: string;          // Required: Name of the tomato
  variety: string;       // Required: Variety/type of tomato
  price: number;         // Required: Price (must be non-negative)
  description?: string;  // Optional: Description
  inStock?: boolean;     // Optional: Stock status (default: true)
  createdAt: number;     // Auto-generated timestamp
  updatedAt: number;     // Auto-updated timestamp
}
```

## Development

### Available Scripts

- `npm start` - Start the production server
- `npm run dev` - Start the development server with hot reload
- `npm run convex:dev` - Start Convex development server
- `npm test` - Run the test suite
- `npm run test:watch` - Run tests in watch mode
- `npm run test:coverage` - Run tests with coverage report

### Project Structure
```
tomatoes-api/
├── convex/
│   ├── schema.ts          # Database schema definition
│   └── tomatoes.ts        # Convex functions (queries & mutations)
├── routes/
│   └── tomatoes.js        # Express routes for tomatoes
├── tests/
│   ├── api.test.js        # API endpoint tests
│   ├── convex.test.js     # Convex function tests
│   ├── performance.test.js # Performance tests
│   ├── setup.js           # Test setup and mocks
│   ├── app.js             # Test application
│   └── README.md          # Test documentation
├── index.js               # Main server file
├── package.json
├── vitest.config.js       # Test configuration
├── convex.json           # Convex configuration
├── .env.example          # Environment variables template
└── README.md
```

### Testing

The project includes a comprehensive test suite with:

- **API Tests**: Test all endpoints for correct functionality
- **Unit Tests**: Test individual Convex functions
- **Performance Tests**: Validate response times and concurrent handling
- **Integration Tests**: Test complete CRUD workflows

**Running Tests:**
```bash
# Run all tests
npm test

# Run tests in watch mode (for development)
npm run test:watch

# Run tests with coverage report
npm run test:coverage
```

**Test Coverage:**
- 52 tests covering all API endpoints
- Mock Convex database for isolated testing
- Performance benchmarks for response times
- Memory usage and concurrency testing

See `tests/README.md` for detailed test documentation.

## Error Handling

The API includes comprehensive error handling:

- **400 Bad Request**: Invalid input data
- **404 Not Found**: Resource not found
- **500 Internal Server Error**: Server errors

All error responses follow this format:
```json
{
  "success": false,
  "error": "Error message description"
}
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly
5. Submit a pull request

## License

ISC License

